<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI 丹田呼吸 V9</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f0f4f8; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; touch-action: manipulation; }
        .container { background: white; padding: 25px 15px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .settings { display: flex; justify-content: space-around; margin-bottom: 15px; gap: 10px; }
        .input-group { display: flex; flex-direction: column; flex: 1; }
        .input-group label { font-size: 0.8rem; color: #7f8c8d; margin-bottom: 5px; }
        input[type="number"] { padding: 10px; font-size: 1.1rem; border: 2px solid #ecf0f1; border-radius: 10px; text-align: center; width: 100%; box-sizing: border-box; }
        .status { font-size: 2.2rem; font-weight: bold; color: #3498db; min-height: 3rem; margin-top: 5px; }
        .timer { font-size: 5rem; font-weight: bold; margin: 5px 0; font-variant-numeric: tabular-nums; }
        .sets-info { font-size: 1rem; color: #95a5a6; margin-bottom: 20px; }
        .controls { display: flex; gap: 8px; flex-direction: column; }
        button { border: none; padding: 16px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; font-weight: bold; width: 100%; -webkit-appearance: none; }
        #btnStart { background: #2ecc71; color: white; }
        #btnPause { background: #f1c40f; color: white; display: none; }
        #btnStop { background: #e74c3c; color: white; display: none; margin-top: 5px; }
        .inhaling .status { color: #2ecc71; }
        .exhaling .status { color: #e74c3c; }
    </style>
</head>
<body id="body">

<div class="container">
    <div id="setup" class="settings">
        <div class="input-group">
            <label>每段秒數</label>
            <input type="number" id="secInput" value="15">
        </div>
        <div class="input-group">
            <label>總組數</label>
            <input type="number" id="setInput" value="10">
        </div>
    </div>

    <div class="status" id="st">準備開始</div>
    <div class="timer" id="tm">00</div>
    <div class="sets-info" id="setsDisplay">組數: 0 / 0</div>

    <div class="controls">
        <button id="btnStart">開始練習</button>
        <button id="btnPause">暫停</button>
        <button id="btnStop">停止重設</button>
    </div>
</div>

<script>
    let timerInterval = null;
    let isPaused = false;
    let currentSet = 1, targetSets = 10, targetSec = 15, timeLeft = 0;
    let currentPhase = "";
    const synth = window.speechSynthesis;

    // 手機版按鈕綁定優化
    document.getElementById('btnStart').onclick = handleStart;
    document.getElementById('btnPause').onclick = handlePause;
    document.getElementById('btnStop').onclick = handleStop;

    function speak(text, callback) {
        synth.cancel();
        const u = new SpeechSynthesisUtterance(text);
        u.lang = 'zh-TW';
        u.rate = 1.0;
        u.onend = () => { if (callback && !isPaused) callback(); };
        synth.speak(u);
        setTimeout(() => { if (callback && !isPaused && !synth.speaking) callback(); }, 2500);
    }

    function handleStart() {
        if (isPaused) {
            isPaused = false;
            document.getElementById('btnPause').innerText = "暫停";
            runTimer(timeLeft, currentPhase === "inhale" ? "exhale" : "next");
            return;
        }

        targetSec = parseInt(document.getElementById('secInput').value) || 15;
        targetSets = parseInt(document.getElementById('setInput').value) || 10;
        currentSet = 1;
        
        document.getElementById('setup').style.display = 'none';
        document.getElementById('btnStart').style.display = 'none';
        document.getElementById('btnPause').style.display = 'block';
        document.getElementById('btnStop').style.display = 'block';
        
        updateSetUI();
        speak(`丹田呼吸，${targetSec}秒，${targetSets}組。三。二。一。`, () => startCycle("inhale"));
    }

    function handlePause() {
        if (!isPaused) {
            isPaused = true;
            clearInterval(timerInterval);
            synth.cancel();
            document.getElementById('btnPause').innerText = "繼續";
            document.getElementById('st').innerText = "已暫停";
        } else {
            handleStart();
        }
    }

    function handleStop() {
        clearInterval(timerInterval);
        synth.cancel();
        isPaused = false;
        currentSet = 1;
        document.getElementById('tm').innerText = "00";
        document.getElementById('st').innerText = "準備開始";
        document.getElementById('body').className = "";
        document.getElementById('setup').style.display = 'flex';
        document.getElementById('btnStart').style.display = 'block';
        document.getElementById('btnPause').style.display = 'none';
        document.getElementById('btnStop').style.display = 'none';
        document.getElementById('btnPause').innerText = "暫停";
    }

    function startCycle(phase) {
        if (isPaused || currentSet > targetSets) { if(currentSet > targetSets) finish(); return; }
        currentPhase = phase;
        updateSetUI();
        const isInhale = phase === "inhale";
        document.getElementById('body').className = isInhale ? "inhaling" : "exhaling";
        document.getElementById('st').innerText = isInhale ? "吸氣" : "吐氣";
        speak(isInhale ? "吸氣" : "吐氣", () => runTimer(targetSec, isInhale ? "exhale" : "next"));
    }

    function runTimer(seconds, nextStep) {
        timeLeft = seconds;
        document.getElementById('tm').innerText = timeLeft < 10 ? '0' + timeLeft : timeLeft;
        clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            if (isPaused) return;
            timeLeft--;
            document.getElementById('tm').innerText = timeLeft < 10 ? '0' + timeLeft : timeLeft;
            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                if (nextStep === "exhale") startCycle("exhale");
                else { currentSet++; startCycle("inhale"); }
            }
        }, 1000);
    }

    function updateSetUI() {
        document.getElementById('setsDisplay').innerText = `組數: ${currentSet} / ${targetSets}`;
    }

    function finish() {
        document.getElementById('st').innerText = "完成";
        speak("練習結束");
        setTimeout(handleStop, 2000);
    }
</script>
</body>
</html>
